<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blood Donation System</title>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.box{
  background:#020617;
  padding:25px;
  border-radius:10px;
  width:340px;
  text-align:center;
  box-shadow:0 0 12px #ef4444;
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:5px;
  border:none;
  outline:none;
}
button{
  background:#ef4444;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
.link{
  color:#22c55e;
  cursor:pointer;
  font-size:14px;
}
.hidden{display:none;}
</style>
</head>

<body>

<div class="box">

  <!-- SEARCH PAGE -->
  <div id="searchPage">
    <h2>ü©∏ Blood Donor Search</h2>

    <select id="s_blood">
      <option value="">Select Blood</option>
      <option>O+</option><option>O-</option>
      <option>A+</option><option>A-</option>
      <option>B+</option><option>B-</option>
      <option>AB+</option><option>AB-</option>
    </select>

    <input id="s_city" placeholder="Enter City">

    <button onclick="searchDonor()">Search</button>

    <div id="result"></div>

    <p class="link" onclick="showRegister()">Become a Donor ‚Üí</p>
  </div>

  <!-- REGISTER PAGE -->
  <div id="registerPage" class="hidden">
    <h2>ü©∏ Donor Registration</h2>

    <input id="name" placeholder="Name">
    <input id="age" placeholder="Age">
    <select id="blood">
      <option>O+</option><option>O-</option>
      <option>A+</option><option>A-</option>
      <option>B+</option><option>B-</option>
      <option>AB+</option><option>AB-</option>
    </select>
    <input id="city" placeholder="City">
    <input id="phone" placeholder="Phone">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">

    <button onclick="register()">Register & Verify Email</button>

    <div id="msg"></div>

    <p class="link" onclick="showSearch()">‚Üê Back to Search</p>
  </div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, setDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, sendEmailVerification }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9xmxYgma37ABQKKmVbOME-ndACMPB200",
  authDomain: "blood-donar-9f832.firebaseapp.com",
  projectId: "blood-donar-9f832",
  storageBucket: "blood-donar-9f832.firebasestorage.app",
  messagingSenderId: "913291193453",
  appId: "1:913291193453:web:f7f5f0f6fd1d103c03a364"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* UI Switch */
window.showRegister = ()=>{
  searchPage.classList.add("hidden");
  registerPage.classList.remove("hidden");
}

window.showSearch = ()=>{
  registerPage.classList.add("hidden");
  searchPage.classList.remove("hidden");
}

/* SEARCH */
window.searchDonor = async ()=>{

  let blood = s_blood.value.toLowerCase();
  let city  = s_city.value.trim().toLowerCase();

  if(!blood || !city) return alert("Enter Blood & City");

  const q = query(collection(db,"donors"),
    where("bloodLower","==",blood),
    where("cityLower","==",city)
  );

  const snap = await getDocs(q);

  let out="";
  snap.forEach(d=>{
    let x=d.data();
    out+=`<p><b>${x.name}</b><br>üìû ${x.phone}</p><hr>`;
  });

  result.innerHTML = out || "‚ùå No donors found";
}

/* REGISTER + EMAIL VERIFY */
window.register = async ()=>{

  try{
    let user = await createUserWithEmailAndPassword(auth,email.value,pass.value);

    await sendEmailVerification(user.user);

    await setDoc(doc(db,"donors",user.user.uid),{
      name:name.value,
      age:age.value,
      phone:phone.value,
      blood:blood.value,
      bloodLower:blood.value.toLowerCase(),
      city:city.value,
      cityLower:city.value.toLowerCase(),
      email:email.value
    });

    msg.innerHTML="‚úÖ Registered! Check email to verify.";
  }
  catch(err){
    msg.innerHTML="‚ùå "+err.message;
  }
}

</script>

</body>
</html>
